<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å°å£é…é€ é †è·¯å¸³ï¼ˆå…¥åŠ›ï¼‹åœ°å›³ï¼‹ãƒªã‚¹ãƒˆï¼‰</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --panel:#121a33;
      --panel2:#0f1730;
      --text:#e9eefc;
      --muted:#a8b2d6;
      --line:rgba(255,255,255,.10);
      --accent:#6ea8ff;
      --good:#48d597;
      --warn:#ffcc66;
      --danger:#ff6b6b;
      --r:16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background: radial-gradient(1200px 700px at 10% 0%, rgba(110,168,255,.22), transparent 60%),
                  radial-gradient(900px 600px at 90% 0%, rgba(72,213,151,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }

    header{
      position:sticky; top:0; z-index:50;
      padding:10px 12px 12px;
      background: linear-gradient(to bottom, rgba(11,16,32,.95), rgba(11,16,32,.70));
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }

    .row{ display:flex; gap:10px; align-items:center; }
    .title{
      font-weight:800;
      letter-spacing:.03em;
      font-size:16px;
      margin:0 0 8px;
      opacity:.95;
    }

    .inputGrid{ display:grid; grid-template-columns: 1fr; gap:8px; }
    .field{
      display:flex; gap:8px; align-items:center;
      padding:10px;
      background: rgba(18,26,51,.85);
      border:1px solid var(--line);
      border-radius: var(--r);
    }
    .field input{
      width:100%;
      border:0;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size:16px;
    }
    .field input::placeholder{ color: rgba(233,238,252,.45); }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 999px;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: rgba(110,168,255,.18); border-color: rgba(110,168,255,.35); }
    .btn.good{ background: rgba(72,213,151,.16); border-color: rgba(72,213,151,.35); }
    .btn.danger{ background: rgba(255,107,107,.12); border-color: rgba(255,107,107,.3); }
    .btn.small{ padding:8px 10px; font-size:13px; }
    .btn.icon{ width:42px; padding:10px 0; }

    .status{
      margin-top:8px;
      font-size:12px;
      color: var(--muted);
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .pill{
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.05);
    }

    #mapWrap{
      padding:12px;
    }
    #map{
      height: 46vh;
      min-height: 320px;
      border-radius: calc(var(--r) + 6px);
      border:1px solid var(--line);
      overflow:hidden;
      box-shadow: 0 16px 50px rgba(0,0,0,.35);
    }

    main{ padding-bottom: 18px; }
    .panel{
      margin: 0 12px 12px;
      padding: 12px;
      border-radius: calc(var(--r) + 6px);
      border:1px solid var(--line);
      background: rgba(18,26,51,.60);
      backdrop-filter: blur(8px);
    }

    .listHeader{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom: 10px;
    }
    .listHeader .meta{ color:var(--muted); font-size:12px; }
    .list{
      display:flex; flex-direction:column; gap:10px;
      max-height: 38vh;
      overflow:auto;
      padding-right: 4px;
    }
    .card{
      border:1px solid var(--line);
      background: rgba(15,23,48,.68);
      border-radius: var(--r);
      padding: 10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
    }
    .card.done{ opacity:.55; filter:saturate(.7); }
    .num{
      font-weight:900;
      color: rgba(233,238,252,.9);
      margin-right:8px;
    }
    .name{ font-weight:800; font-size:15px; }
    .addr{ color: var(--muted); font-size:12.5px; margin-top:2px; line-height:1.35; }
    .actions{ display:flex; flex-direction:column; gap:8px; justify-content:center; }
    .hint{
      color: rgba(233,238,252,.55);
      font-size:12px;
      margin-top:10px;
      line-height:1.45;
    }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 14px;
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.65);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      font-size: 13px;
      display:none;
      max-width: min(92vw, 540px);
      text-align:center;
      backdrop-filter: blur(8px);
    }
  </style>
</head>

<body>
  <header>
    <div class="title">å°å£é…é€ é †è·¯å¸³ï¼ˆå…¥åŠ›ï¼‹åœ°å›³ï¼‹ãƒªã‚¹ãƒˆï¼‰</div>

    <div class="inputGrid">
      <div class="field">
        <button class="btn icon" id="micName" title="éŸ³å£°å…¥åŠ›ï¼ˆé…é€å…ˆåï¼‰">ğŸ¤</button>
        <input id="name" type="text" placeholder="é…é€å…ˆåï¼ˆä¾‹ï¼šã€‡ã€‡å•†åº— / â–³â–³æ§˜ï¼‰" autocomplete="off">
      </div>

      <div class="field">
        <button class="btn icon" id="micAddr" title="éŸ³å£°å…¥åŠ›ï¼ˆä½æ‰€ï¼‰">ğŸ¤</button>
        <input id="addr" type="text" placeholder="ä½æ‰€ï¼ˆä¾‹ï¼šæ»‹è³€çœŒå¤§æ´¥å¸‚ã€‡ã€‡ç”º1-2-3ï¼‰" autocomplete="off">
      </div>

      <div class="row" style="justify-content:space-between;">
        <button class="btn primary" id="addBtn">ï¼‹ è¿½åŠ ï¼ˆä½æ‰€â†’åº§æ¨™â†’ãƒ”ãƒ³ï¼‰</button>
        <div class="row">
          <button class="btn small" id="locBtn">ğŸ“ ç¾åœ¨åœ°</button>
          <button class="btn small danger" id="clearBtn">ğŸ—‘ å…¨æ¶ˆå»</button>
        </div>
      </div>

      <div class="status">
        <div class="pill" id="countPill">ä»¶æ•°ï¼š0</div>
        <div class="pill" id="speechPill">éŸ³å£°ï¼šæœªç¢ºèª</div>
        <div class="pill" id="geoPill">ä½ç½®æƒ…å ±ï¼šæœªç¢ºèª</div>
      </div>
    </div>
  </header>

  <main>
    <div id="mapWrap">
      <div id="map"></div>
    </div>

    <section class="panel">
      <div class="listHeader">
        <div>
          <div style="font-weight:900;">é…é€å…ˆãƒªã‚¹ãƒˆ</div>
          <div class="meta">20ä»¶ä»¥ä¸ŠOKï¼ˆå®Œäº†ã§ä¸‹ãŒã‚‹ / åœ°å›³ã¯æœ€å¾Œã«è¿½åŠ ã—ãŸåœ°ç‚¹ã‚’è‡ªå‹•ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼‰</div>
        </div>
        <button class="btn small" id="fitBtn">ğŸ§­ å…¨ä½“è¡¨ç¤º</button>
      </div>

      <div class="list" id="list"></div>

      <div class="hint">
        â€»éŸ³å£°å…¥åŠ›ã¯ <b>Chromeç³»ãƒ–ãƒ©ã‚¦ã‚¶</b>ã§å‹•ä½œã—ã‚„ã™ã„ã§ã™ã€‚<br>
        â€»éŸ³å£°å…¥åŠ›ã¯å¤šãã®ç«¯æœ«ã§ <b>HTTPS</b> ãŒå¿…è¦ã§ã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚OKãªå ´åˆã‚ã‚Šï¼‰ã€‚<br>
        â€»ä½æ‰€â†’åº§æ¨™ã¯OpenStreetMapã®Nominatimã‚’ä½¿ç”¨ï¼ˆé€£ç¶šå¤§é‡å…¥åŠ›ã¯å°‘ã—é–“éš”ã‚’ç©ºã‘ã¦ãã ã•ã„ï¼‰ã€‚
      </div>
    </section>
  </main>

  <div class="toast" id="toast"></div>

<script>
(() => {
  // ========= Utilities =========
  const $ = (id) => document.getElementById(id);
  const toastEl = $("toast");
  let toastTimer = null;
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toastEl.style.display = "none", 2200);
  }
  function esc(s){ return (s ?? "").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // ========= State =========
  const STORAGE_KEY = "koguchi_delivery_stops_v1";
  /** @type {{id:string,name:string,address:string,lat:number,lng:number,status:"pending"|"done",createdAt:number}[]} */
  let stops = [];

  // ========= Map =========
  const map = L.map("map", { zoomControl: false }).setView([35.02, 135.86], 12); // æ»‹è³€ä»˜è¿‘ï¼ˆåˆæœŸï¼‰
  L.control.zoom({ position: "bottomright" }).addTo(map);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  const markersLayer = L.layerGroup().addTo(map);

  // current location marker
  let currentMarker = null;
  let currentLatLng = null;

  // ========= Persistence =========
  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw) stops = JSON.parse(raw) || [];
    }catch(e){ stops = []; }
  }
  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(stops));
  }

  // ========= Geocoding (Nominatim) =========
  // NOTE: Nominatim has usage policies; avoid heavy bursts.
  async function geocodeAddress(address){
  const url = new URL("/api/geocode", location.origin);
  url.searchParams.set("q", address);

  const res = await fetch(url.toString(), {
    headers: { "Accept": "application/json" }
  });
  if(!res.ok) throw new Error("ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å¤±æ•—");

  const j = await res.json();
  if(!j.ok || !j.found) return null;

  return { lat: j.lat, lng: j.lng, display: j.display };
}




  // ========= Render =========
  function updatePills(){
    $("countPill").textContent = `ä»¶æ•°ï¼š${stops.length}`;
  }

  function iconForStop(index, status){
    // simple numbered label via DivIcon
    const n = index + 1;
    const bg = status === "done" ? "rgba(255,255,255,.18)" : "rgba(110,168,255,.28)";
    const bd = status === "done" ? "rgba(255,255,255,.22)" : "rgba(110,168,255,.55)";
    const color = "rgba(233,238,252,.95)";
    return L.divIcon({
      className: "",
      html: `
        <div style="
          width:34px;height:34px;border-radius:999px;
          display:grid;place-items:center;
          background:${bg};
          border:1px solid ${bd};
          color:${color};
          font-weight:900;
          box-shadow:0 10px 30px rgba(0,0,0,.35);
          backdrop-filter: blur(6px);
        ">${n}</div>
      `,
      iconSize: [34,34],
      iconAnchor: [17,34]
    });
  }

  function redrawMarkers(){
    markersLayer.clearLayers();

    stops.forEach((s, i) => {
      const m = L.marker([s.lat, s.lng], { icon: iconForStop(i, s.status) })
        .addTo(markersLayer)
        .bindPopup(`<b>${esc(s.name || "ï¼ˆåç§°ãªã—ï¼‰")}</b><br>${esc(s.address)}`);
      // store marker ref if needed later
      s._marker = m;
    });
  }

  function renderList(){
    const list = $("list");
    list.innerHTML = "";

    // Show pending first, then done (but keep numbering by overall order)
    // If you prefer strict input order, remove sort and just loop stops.
    const pending = stops.filter(s => s.status === "pending");
    const done = stops.filter(s => s.status === "done");
    const ordered = [...pending, ...done];

    ordered.forEach((s) => {
      const idx = stops.findIndex(x => x.id === s.id); // original index for marker number
      const card = document.createElement("div");
      card.className = "card" + (s.status === "done" ? " done" : "");
      card.innerHTML = `
        <div>
          <div class="name"><span class="num">${idx+1}</span>${esc(s.name || "ï¼ˆåç§°ãªã—ï¼‰")}</div>
          <div class="addr">${esc(s.address)}</div>
        </div>
        <div class="actions">
          <button class="btn small primary" data-action="nav" data-id="${esc(s.id)}">â–¶ ãƒŠãƒ“</button>
          <button class="btn small good" data-action="done" data-id="${esc(s.id)}">âœ” å®Œäº†</button>
          <button class="btn small" data-action="focus" data-id="${esc(s.id)}">ğŸ—º åœ°å›³</button>
        </div>
      `;
      list.appendChild(card);
    });

    updatePills();
  }

  function focusStop(id){
    const s = stops.find(x => x.id === id);
    if(!s) return;
    map.setView([s.lat, s.lng], Math.max(map.getZoom(), 16), { animate:true });
    if(s._marker) s._marker.openPopup();
  }

  function fitAll(){
    if(stops.length === 0){
      toast("é…é€å…ˆãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }
    const latlngs = stops.map(s => [s.lat, s.lng]);
    const bounds = L.latLngBounds(latlngs);
    map.fitBounds(bounds.pad(0.22));
  }

  // ========= Actions =========
  async function addStop(){
    const name = $("name").value.trim();
    const address = $("addr").value.trim();

    if(!address){
      toast("ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      $("addr").focus();
      return;
    }

    $("addBtn").disabled = true;
    $("addBtn").textContent = "â€¦åº§æ¨™åŒ–ä¸­";

    try{
      const geo = await geocodeAddress(address);
      if(!geo){
        toast("ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆè¡¨è¨˜ã‚’å¤‰ãˆã¦ã¿ã¦ãã ã•ã„ï¼‰");
        return;
      }

      const id = crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2);

      const stop = {
        id,
        name: name || "",
        address,
        lat: geo.lat,
        lng: geo.lng,
        status: "pending",
        createdAt: Date.now()
      };

      stops.push(stop);
      save();

      redrawMarkers();
      renderList();

      // focus latest
      map.setView([stop.lat, stop.lng], 16, { animate:true });

      // clear inputs for next
      $("name").value = "";
      $("addr").value = "";
      $("name").focus();

      toast("è¿½åŠ ã—ã¾ã—ãŸ");
    }catch(e){
      console.error(e);
      toast("åº§æ¨™åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé€šä¿¡/ä½æ‰€è¡¨è¨˜ã‚’ç¢ºèªï¼‰");
    }finally{
      $("addBtn").disabled = false;
      $("addBtn").textContent = "ï¼‹ è¿½åŠ ï¼ˆä½æ‰€â†’åº§æ¨™â†’ãƒ”ãƒ³ï¼‰";
    }
  }

  function setDone(id){
    const s = stops.find(x => x.id === id);
    if(!s) return;
    s.status = (s.status === "done") ? "pending" : "done";
    save();
    redrawMarkers();
    renderList();
  }

  function openNav(id){
    const s = stops.find(x => x.id === id);
    if(!s) return;

    // If current location known, provide navigation-friendly URL (Google Maps directions)
    const base = new URL("https://www.google.com/maps/dir/");
    if(currentLatLng){
      base.pathname = `/maps/dir/${currentLatLng.lat},${currentLatLng.lng}/${s.lat},${s.lng}/`;
    }else{
      // fallback: just show destination
      base.pathname = "/maps/search/";
      base.searchParams.set("api", "1");
      base.searchParams.set("query", `${s.lat},${s.lng}`);
    }
    window.open(base.toString(), "_blank");
  }

  function clearAll(){
    if(!confirm("å…¨ã¦ã®é…é€å…ˆã‚’æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    stops = [];
    save();
    redrawMarkers();
    renderList();
    toast("å…¨æ¶ˆå»ã—ã¾ã—ãŸ");
  }

  // ========= Geolocation =========
  async function getLocation(){
    if(!navigator.geolocation){
      $("geoPill").textContent = "ä½ç½®æƒ…å ±ï¼šéå¯¾å¿œ";
      toast("ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“");
      return;
    }
    $("geoPill").textContent = "ä½ç½®æƒ…å ±ï¼šå–å¾—ä¸­â€¦";
    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      currentLatLng = { lat, lng };
      $("geoPill").textContent = "ä½ç½®æƒ…å ±ï¼šOK";

      if(currentMarker){
        currentMarker.setLatLng([lat,lng]);
      }else{
        currentMarker = L.circleMarker([lat,lng], {
          radius: 8,
          weight: 2,
          opacity: 1,
          fillOpacity: .35
        }).addTo(map).bindPopup("ç¾åœ¨åœ°");
      }
      map.setView([lat,lng], Math.max(map.getZoom(), 15), { animate:true });
      toast("ç¾åœ¨åœ°ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
    }, (err) => {
      console.warn(err);
      $("geoPill").textContent = "ä½ç½®æƒ…å ±ï¼šNG";
      toast("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ï¼ˆè¨±å¯/é›»æ³¢ã‚’ç¢ºèªï¼‰");
    }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 4000 });
  }

  // ========= Speech (Web Speech API) =========
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recog = null;

  function initSpeech(){
    if(!SpeechRecognition){
      $("speechPill").textContent = "éŸ³å£°ï¼šéå¯¾å¿œ";
      return;
    }
    $("speechPill").textContent = "éŸ³å£°ï¼šOK";
    recog = new SpeechRecognition();
    recog.lang = "ja-JP";
    recog.interimResults = false;
    recog.maxAlternatives = 1;
  }

  function speakToInput(inputEl){
    if(!recog){
      toast("éŸ³å£°å…¥åŠ›ãŒä½¿ãˆã¾ã›ã‚“ï¼ˆChromeç³»æ¨å¥¨ï¼‰");
      return;
    }
    try{
      recog.abort(); // reset
    }catch(e){}

    toast("è©±ã—ã¦ãã ã•ã„â€¦");
    recog.onresult = (ev) => {
      const text = ev.results[0][0].transcript || "";
      // append if already has text
      const cur = inputEl.value.trim();
      inputEl.value = cur ? (cur + " " + text) : text;
      toast("å…¥åŠ›ã—ã¾ã—ãŸ");
    };
    recog.onerror = (ev) => {
      console.warn(ev);
      toast("éŸ³å£°å…¥åŠ›ã«å¤±æ•—ï¼ˆæ¨©é™/HTTPSã‚’ç¢ºèªï¼‰");
    };
    recog.onend = () => {};
    recog.start();
  }

  // ========= Event bindings =========
  $("addBtn").addEventListener("click", addStop);
  $("clearBtn").addEventListener("click", clearAll);
  $("fitBtn").addEventListener("click", fitAll);
  $("locBtn").addEventListener("click", getLocation);

  $("name").addEventListener("keydown", (e) => {
    if(e.key === "Enter"){ $("addr").focus(); }
  });
  $("addr").addEventListener("keydown", (e) => {
    if(e.key === "Enter"){ addStop(); }
  });

  $("micName").addEventListener("click", () => speakToInput($("name")));
  $("micAddr").addEventListener("click", () => speakToInput($("addr")));

  $("list").addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if(!btn) return;
    const id = btn.getAttribute("data-id");
    const action = btn.getAttribute("data-action");
    if(!id || !action) return;

    if(action === "nav") openNav(id);
    if(action === "done") setDone(id);
    if(action === "focus") focusStop(id);
  });

  // ========= Boot =========
  load();
  initSpeech();
  redrawMarkers();
  renderList();

  // first checks
  if(SpeechRecognition) $("speechPill").textContent = "éŸ³å£°ï¼šOK";
  else $("speechPill").textContent = "éŸ³å£°ï¼šéå¯¾å¿œ";

  if(navigator.geolocation) $("geoPill").textContent = "ä½ç½®æƒ…å ±ï¼šæœªå–å¾—";
  else $("geoPill").textContent = "ä½ç½®æƒ…å ±ï¼šéå¯¾å¿œ";

  // Optional: auto get location once
  // getLocation();

})();
</script>
</body>
</html>
